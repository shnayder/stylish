<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Style Explorer</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/surface.css">
  <link rel="stylesheet" href="styles/modal.css">
</head>
<body>
  <!-- Settings toggle button -->
  <button class="settings-toggle" id="settings-toggle">Settings</button>

  <!-- Stats toggle button -->
  <button class="stats-toggle" id="stats-toggle">Stats</button>

  <!-- Stats panel -->
  <div class="stats-panel" id="stats-panel">
    <h3>LLM Usage Stats</h3>
    <div class="stats-summary">
      <div class="stat-item">
        <span class="stat-label">Total Calls</span>
        <span class="stat-value" id="stat-calls">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Input Tokens</span>
        <span class="stat-value" id="stat-input-tokens">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Output Tokens</span>
        <span class="stat-value" id="stat-output-tokens">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Total Tokens</span>
        <span class="stat-value" id="stat-total-tokens">0</span>
      </div>
    </div>
    <div class="stats-costs">
      <h4>Estimated API Costs</h4>
      <div class="cost-grid" id="cost-grid"></div>
    </div>
    <div class="stats-actions">
      <button class="action-btn" id="reset-stats">Reset Stats</button>
    </div>
  </div>

  <!-- Settings panel -->
  <div class="settings-panel" id="settings-panel">
    <h3>LLM Configuration</h3>
    <div class="settings-status" id="settings-status" style="display: none;"></div>

    <div class="settings-group">
      <label>Provider</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="provider" value="local" checked>
          Local (LM Studio)
        </label>
        <label>
          <input type="radio" name="provider" value="anthropic">
          Claude API
        </label>
      </div>
    </div>

    <div class="settings-group" id="local-settings">
      <label for="local-url">Local API URL</label>
      <input type="text" id="local-url" value="http://localhost:1234" placeholder="http://localhost:1234">
      <div class="hint">LM Studio default: http://localhost:1234</div>
    </div>

    <div class="settings-group" id="anthropic-settings" style="display: none;">
      <label for="anthropic-key">Anthropic API Key</label>
      <input type="password" id="anthropic-key" placeholder="sk-ant-...">
      <div class="hint">Stored in localStorage (browser only)</div>
    </div>

    <div class="settings-actions">
      <button class="action-btn primary" id="test-connection">Test Connection</button>
      <button class="action-btn" id="save-settings">Save</button>
    </div>

    <div class="settings-group">
      <label>Data Management</label>
      <div class="settings-actions">
        <button class="action-btn" id="export-data">Export</button>
        <button class="action-btn" id="import-data">Import</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header class="app-header">
      <h1>Writing Style Explorer</h1>
    </header>

    <!-- Context Panel (collapsible) -->
    <div class="context-panel collapsible" id="context-panel">
      <div class="collapsible-header" id="context-toggle">
        <h2>Context</h2>
        <span class="collapse-icon">&#9662;</span>
      </div>
      <div class="collapsible-body" id="context-body">
        <div class="context-panes">
          <div class="context-pane">
            <label for="setting-input">What I'm Describing</label>
            <textarea id="setting-input" placeholder="Describe your setting, characters, situation...">Setting: Rivendell, the Last Homely House

Known details:
- Hidden valley in the Misty Mountains
- Elven refuge founded by Elrond
- Waterfalls, pine trees, ancient stone buildings
- A place of rest, learning, and healing
- Twilight atmosphere, stars visible even at dusk

Context: First arrival of weary travelers seeking sanctuary</textarea>
          </div>
          <div class="context-pane">
            <label for="scene-input">This Scene</label>
            <textarea id="scene-input" placeholder="Goals for this specific scene...">- Convey sense of relief and safety after danger
- Show the otherworldly, timeless quality of the Elves
- Use sensory details beyond just visual
- Length: 2-3 paragraphs
- First person POV from Bilbo, past tense
- Spare, grounded prose style</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Writing Surface -->
    <div class="writing-surface" id="writing-surface">
      <div class="surface-toolbar">
        <button class="action-btn primary" id="generate-draft-btn">Generate Draft</button>
        <div class="toolbar-spacer"></div>
        <button class="action-btn" id="evaluate-btn">Evaluate</button>
      </div>
      <textarea id="writing-text" placeholder="Write or paste your text here, or click Generate Draft to get a starting point..."></textarea>
    </div>

    <!-- Annotations Area (Mirror threads, Lens results, Variations) -->
    <div class="annotations-area" id="annotations-area"></div>

    <!-- Style Guide Panel (collapsible) -->
    <div class="style-guide-panel collapsible" id="style-guide-panel">
      <div class="collapsible-header" id="style-guide-toggle">
        <h2>Style Guide <span class="rule-count" id="rule-count"></span></h2>
        <div class="panel-actions">
          <button class="action-btn" id="manage-rules-btn">Manage Rules</button>
          <span class="collapse-icon">&#9662;</span>
        </div>
      </div>
      <div class="collapsible-body" id="style-guide-body">
        <div id="style-guide-summary"></div>
      </div>
    </div>
  </div>

  <!-- Selection Menu (floating, shown on text selection) -->
  <div class="selection-menu" id="selection-menu">
    <button class="sel-btn" id="sel-react">React</button>
    <button class="sel-btn" id="sel-variations">Variations</button>
    <button class="sel-btn" id="sel-evaluate">Evaluate</button>
  </div>

  <!-- Full Style Guide Management View -->
  <div class="fullscreen-panel" id="style-guide-full-view">
    <div class="fullscreen-panel-header">
      <button class="action-btn" id="close-full-guide">&larr; Back to Writing</button>
      <h2>Style Guide <span class="rule-count" id="full-rule-count"></span></h2>
      <div class="style-guide-actions">
        <button class="action-btn" id="expand-all-rules">Expand All</button>
        <button class="action-btn" id="collapse-all-rules">Collapse All</button>
        <button class="action-btn" id="reload-style-guide">Reload from file</button>
      </div>
    </div>
    <div class="fullscreen-panel-body">
      <div class="style-guide-content" id="style-guide-content">
        <p class="empty-message">No style rules yet. Use the Mirror flow to crystallize your preferences into rules.</p>
        <div class="rules-list" id="rules-list"></div>
      </div>
    </div>
  </div>

  <!-- Drill-down modal (used by Mirror flow for coaching conversations) -->
  <div class="modal-overlay" id="drill-down-overlay">
    <div class="drill-down-modal">
      <div class="modal-header">
        <h3>Exploring Style</h3>
        <button class="close-modal" id="close-drill-down">&times;</button>
      </div>
      <div class="modal-body">
        <div class="selected-text-box" id="modal-selected-text"></div>
        <div class="initial-reaction-box">
          <label>Your initial reaction</label>
          <div id="modal-initial-reaction"></div>
        </div>
        <div class="conversation-area">
          <div class="conversation-messages" id="conversation-messages">
          </div>
        </div>
        <div class="conversation-input">
          <textarea id="coach-input" placeholder="Type your response..."></textarea>
          <button class="action-btn primary" id="send-to-coach">Send</button>
        </div>
        <div class="proposed-rule" id="proposed-rule">
          <h4>Proposed Style Rule</h4>
          <div class="rule-preview" id="rule-preview">
            <div class="principle" id="preview-principle"></div>
            <div class="examples" id="preview-examples"></div>
          </div>
          <textarea id="rule-edit-area" placeholder="Edit the rule..."></textarea>
          <div style="display: flex; gap: 10px;">
            <button class="action-btn" id="edit-rule-btn">Edit</button>
            <button class="action-btn" id="save-rule-edit" style="display: none;">Done Editing</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" id="keep-exploring">Keep Exploring</button>
        <button class="action-btn primary" id="add-to-style-guide" disabled>Add to Style Guide</button>
      </div>
    </div>
  </div>

  <!-- Refinement Modal -->
  <div class="modal-overlay" id="refinement-overlay">
    <div class="refinement-modal">
      <div class="modal-header">
        <h3>Refine Style Rule</h3>
        <button class="close-modal" id="close-refinement">&times;</button>
      </div>
      <div class="modal-body">
        <div class="refinement-current-rule">
          <label>Current Rule</label>
          <div class="current-rule-display" id="refinement-current-rule"></div>
        </div>
        <div class="conversation-area">
          <div class="conversation-messages" id="refinement-messages"></div>
        </div>
        <div class="refinement-suggestion" id="refinement-suggestion">
          <div class="suggestion-header">Suggested Update</div>
          <div class="suggestion-content" id="refinement-suggestion-content"></div>
          <div class="suggestion-actions">
            <button class="action-btn" id="ignore-suggestion">Ignore</button>
            <button class="action-btn primary" id="accept-suggestion">Accept</button>
          </div>
        </div>
        <div class="conversation-input">
          <textarea id="refinement-input" placeholder="What would you like to change about this rule?"></textarea>
          <button class="action-btn primary" id="send-refinement">Send</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" id="cancel-refinement">Cancel</button>
        <button class="action-btn primary" id="save-refinement">Done - Save Rule</button>
      </div>
    </div>
  </div>

  <!-- Synthesis Modal -->
  <div class="modal-overlay" id="synthesis-overlay">
    <div class="synthesis-modal">
      <div class="modal-header">
        <h3>Synthesize Feedback into Style Rules</h3>
        <button class="close-modal" id="close-synthesis">&times;</button>
      </div>
      <div class="modal-body">
        <div class="synthesis-loading" id="synthesis-loading">
          <div class="synthesis-spinner"></div>
          <p>Analyzing your feedback...</p>
        </div>
        <div class="synthesis-results" id="synthesis-results"></div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" id="cancel-synthesis">Cancel</button>
        <button class="action-btn primary" id="apply-synthesis" disabled>Add Selected to Style Guide</button>
      </div>
    </div>
  </div>

  <script type="module" src="src/main.js"></script>
</body>
</html>
