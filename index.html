<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Style Explorer</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      margin: 0;
      padding: 20px;
      background: #f5f3ef;
      color: #2c2c2c;
      line-height: 1.6;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #3a3a3a;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .input-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .pane {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .pane h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    .pane-content {
      font-size: 0.95rem;
      color: #444;
    }

    .pane-content p {
      margin: 0 0 10px 0;
    }

    .pane-content ul {
      margin: 0;
      padding-left: 20px;
    }

    .pane-content li {
      margin-bottom: 6px;
    }

    .alternatives-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .alternatives-header h2 {
      font-size: 1.1rem;
      color: #3a3a3a;
      margin: 0;
    }

    .regenerate-btn {
      background: #5a7a5a;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .regenerate-btn:hover {
      background: #4a6a4a;
    }

    .alternatives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .alternative {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }

    .alternative .remove-alternative {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      padding: 4px 8px;
    }

    .alternative .remove-alternative:hover {
      color: #c00;
    }

    .alternative.selected {
      box-shadow: 0 0 0 2px #5a7a5a, 0 2px 8px rgba(0,0,0,0.12);
    }

    .style-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tag {
      background: #e8e4dc;
      color: #5a5a5a;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .tag.tone {
      background: #dce4dc;
      color: #4a5a4a;
    }

    .tag.technique {
      background: #dcdce8;
      color: #4a4a5a;
    }

    .tag.pacing {
      background: #e8dcdc;
      color: #5a4a4a;
    }

    .description-text {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #333;
      cursor: text;
    }

    .description-text p {
      margin: 0 0 1em 0;
    }

    .description-text p:last-child {
      margin-bottom: 0;
    }

    .description-text .highlighted {
      background: #fff3cd;
      border-bottom: 2px solid #ffc107;
    }

    .alternative-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .action-btn {
      background: none;
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
    }

    .action-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .action-btn.primary {
      background: #5a7a5a;
      color: white;
      border-color: #5a7a5a;
    }

    .action-btn.primary:hover {
      background: #4a6a4a;
    }

    /* Selection popup */
    .selection-popup {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 12px;
      z-index: 1000;
      display: none;
      width: 280px;
    }

    .selection-popup.visible {
      display: block;
    }

    .selection-popup .selected-text {
      font-size: 0.8rem;
      color: #666;
      font-style: italic;
      margin-bottom: 8px;
      padding: 6px 8px;
      background: #f9f9f9;
      border-radius: 4px;
      max-height: 60px;
      overflow: hidden;
    }

    .selection-popup textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 60px;
    }

    .selection-popup textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .selection-popup .popup-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-end;
    }

    /* Reaction input for whole alternative */
    .reaction-input {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #ddd;
    }

    .reaction-input textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 50px;
    }

    .reaction-input textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .reaction-input textarea::placeholder {
      color: #999;
    }

    .reaction-input .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .reaction-input .add-reaction-btn {
      flex-shrink: 0;
      margin-top: 0;
    }

    /* Collected reactions */
    .reactions-list {
      margin-top: 10px;
    }

    .reaction-item {
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      position: relative;
    }

    .reaction-item .reaction-quote {
      color: #666;
      font-style: italic;
      font-size: 0.8rem;
      margin-bottom: 6px;
      padding-left: 10px;
      border-left: 2px solid #ddd;
    }

    .reaction-item .reaction-text {
      color: #333;
    }

    .reaction-item .remove-reaction {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 2px 6px;
    }

    .reaction-item .remove-reaction:hover {
      color: #c00;
    }

    /* Reactions summary panel */
    .reactions-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 30px;
    }

    .reactions-panel h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0 0 15px 0;
      font-weight: 600;
    }

    .reactions-panel .empty-state {
      color: #999;
      font-style: italic;
      font-size: 0.9rem;
    }

    .reactions-panel .all-reactions {
      margin-bottom: 15px;
    }

    .reactions-panel .reaction-item {
      background: #f5f5f5;
    }

    .reactions-panel .reaction-item .source-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .reactions-panel .panel-actions {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    /* Style palette */
    .style-palette {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 30px;
    }

    .style-palette-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .style-palette-header h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0;
      font-weight: 600;
    }

    .style-palette-header .selection-count {
      font-size: 0.85rem;
      color: #888;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .style-category h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin: 0 0 10px 0;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .style-option {
      background: #f0f0f0;
      color: #555;
      padding: 4px 12px;
      border-radius: 14px;
      font-size: 0.8rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 2px solid transparent;
      user-select: none;
    }

    .style-option:hover {
      background: #e5e5e5;
    }

    .style-option.selected {
      background: #5a7a5a;
      color: white;
      border-color: #4a6a4a;
    }

    .style-option.selected:hover {
      background: #4a6a4a;
    }

    .style-palette .panel-actions {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .clear-styles-btn {
      margin-left: auto;
    }

    /* Settings panel */
    .settings-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #666;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      z-index: 100;
    }

    .settings-toggle:hover {
      background: #f5f5f5;
    }

    .settings-toggle.connected {
      border-color: #5a7a5a;
      color: #5a7a5a;
    }

    .settings-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 20px;
      width: 320px;
      z-index: 100;
      display: none;
    }

    .settings-panel.visible {
      display: block;
    }

    .settings-panel h3 {
      margin: 0 0 15px 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
    }

    .settings-group {
      margin-bottom: 15px;
    }

    .settings-group label {
      display: block;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .settings-group input[type="text"],
    .settings-group input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .settings-group input:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .settings-group .radio-group {
      display: flex;
      gap: 15px;
    }

    .settings-group .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .settings-group .radio-group input[type="radio"] {
      margin: 0;
    }

    .settings-group .hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .settings-status {
      padding: 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-bottom: 15px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .settings-status.success {
      background: #dce4dc;
      color: #3a5a3a;
    }

    .settings-status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .settings-status.warning {
      background: #fff3cd;
      color: #856404;
    }

    .settings-actions {
      display: flex;
      gap: 10px;
    }

    /* Loading state */
    .generating {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading-indicator {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alternative.loading {
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
    }

    /* Editable panes */
    .pane textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.6;
      resize: none;
      overflow: hidden;
      color: #444;
    }

    .pane textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .pane textarea::placeholder {
      color: #999;
    }

    /* Style Guide Section */
    .style-guide {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .style-guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .style-guide-header h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0;
      font-weight: 600;
    }

    .style-guide-header .rule-count {
      font-size: 0.85rem;
      color: #888;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-guide-header .toggle-icon {
      color: #888;
      font-size: 0.8rem;
    }

    .style-guide-content {
      margin-top: 15px;
      display: none;
    }

    .style-guide-content.expanded {
      display: block;
    }

    .style-guide.empty .style-guide-content {
      color: #999;
      font-style: italic;
      font-size: 0.9rem;
    }

    .style-rule {
      background: #f8f8f8;
      border-radius: 6px;
      padding: 12px 15px;
      margin-bottom: 10px;
      position: relative;
    }

    .style-rule .rule-principle {
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }

    .style-rule .rule-examples {
      font-size: 0.85rem;
      color: #666;
    }

    .style-rule .rule-examples .avoid {
      color: #a55;
    }

    .style-rule .rule-examples .prefer {
      color: #5a5;
    }

    .style-rule .rule-original {
      font-size: 0.85rem;
      color: #555;
      margin: 8px 0;
      padding: 8px 10px;
      background: #fff;
      border-radius: 4px;
      font-style: italic;
    }

    .style-rule .rule-original .example-label {
      font-style: normal;
      font-weight: 500;
      color: #888;
    }

    .style-rule .rule-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 5px;
    }

    .style-rule .rule-actions button {
      background: none;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 2px 6px;
    }

    .style-rule .rule-actions button:hover {
      color: #666;
    }

    .style-rule .rule-actions button.remove:hover {
      color: #c00;
    }

    .style-rule.editing {
      background: #fff;
      border: 1px solid #5a7a5a;
    }

    .style-rule .edit-form {
      display: none;
    }

    .style-rule.editing .edit-form {
      display: block;
    }

    .style-rule.editing .rule-display {
      display: none;
    }

    .style-rule .edit-form label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #888;
      margin: 10px 0 4px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-rule .edit-form label:first-child {
      margin-top: 0;
    }

    .style-rule .edit-form input,
    .style-rule .edit-form textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .style-rule .edit-form textarea {
      min-height: 60px;
      resize: vertical;
    }

    .style-rule .edit-form input:focus,
    .style-rule .edit-form textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .style-rule .edit-form .edit-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Drill-down Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .drill-down-modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #333;
    }

    .modal-header .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
      padding: 0 5px;
    }

    .modal-header .close-modal:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .selected-text-box {
      background: #fff8e0;
      border-left: 3px solid #f0c000;
      padding: 12px 15px;
      margin-bottom: 15px;
      font-style: italic;
      color: #555;
    }

    .initial-reaction-box {
      background: #f0f0f0;
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: #555;
    }

    .initial-reaction-box label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #888;
      display: block;
      margin-bottom: 4px;
    }

    .conversation-area {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .conversation-messages {
      padding: 15px;
    }

    .conv-message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }

    .conv-message:last-child {
      margin-bottom: 0;
    }

    .conv-message .speaker {
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #888;
      flex-shrink: 0;
      width: 50px;
    }

    .conv-message.coach .speaker {
      color: #5a7a5a;
    }

    .conv-message .content {
      font-size: 0.95rem;
      color: #333;
      line-height: 1.5;
    }

    .conv-message.coach .content {
      color: #444;
    }

    .conversation-input {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .conversation-input textarea {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      resize: none;
      min-height: 60px;
    }

    .conversation-input textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .conversation-input button {
      align-self: flex-end;
    }

    .proposed-rule {
      background: #f0f8f0;
      border: 1px solid #c0e0c0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      display: none;
    }

    .proposed-rule.visible {
      display: block;
    }

    .proposed-rule h4 {
      margin: 0 0 10px 0;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: #5a7a5a;
    }

    .proposed-rule .rule-preview {
      margin-bottom: 15px;
    }

    .proposed-rule .rule-preview .principle {
      font-weight: 500;
      margin-bottom: 8px;
    }

    .proposed-rule .rule-preview .examples {
      font-size: 0.9rem;
      color: #555;
    }

    .proposed-rule textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #c0e0c0;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.9rem;
      min-height: 80px;
      margin-bottom: 10px;
      display: none;
    }

    .proposed-rule textarea.editing {
      display: block;
    }

    .proposed-rule .rule-preview.editing {
      display: none;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>
<body>
  <!-- Settings toggle button -->
  <button class="settings-toggle" id="settings-toggle">Settings</button>

  <!-- Settings panel -->
  <div class="settings-panel" id="settings-panel">
    <h3>LLM Configuration</h3>
    <div class="settings-status" id="settings-status" style="display: none;"></div>

    <div class="settings-group">
      <label>Provider</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="provider" value="local" checked>
          Local (LM Studio)
        </label>
        <label>
          <input type="radio" name="provider" value="anthropic">
          Claude API
        </label>
      </div>
    </div>

    <div class="settings-group" id="local-settings">
      <label for="local-url">Local API URL</label>
      <input type="text" id="local-url" value="http://localhost:1234" placeholder="http://localhost:1234">
      <div class="hint">LM Studio default: http://localhost:1234</div>
    </div>

    <div class="settings-group" id="anthropic-settings" style="display: none;">
      <label for="anthropic-key">Anthropic API Key</label>
      <input type="password" id="anthropic-key" placeholder="sk-ant-...">
      <div class="hint">Stored in localStorage (browser only)</div>
    </div>

    <div class="settings-actions">
      <button class="action-btn primary" id="test-connection">Test Connection</button>
      <button class="action-btn" id="save-settings">Save</button>
    </div>
  </div>

  <div class="container">
    <h1>Writing Style Explorer</h1>

    <div class="input-section">
      <div class="pane">
        <h2>What I'm Describing</h2>
        <textarea id="setting-input" placeholder="Describe your setting...

Example:
Setting: Rivendell, the Last Homely House

Known details:
- Hidden valley in the Misty Mountains
- Elven refuge founded by Elrond
- Waterfalls, pine trees, ancient stone buildings
- A place of rest, learning, and healing

Context: First arrival of weary travelers seeking sanctuary">Setting: Rivendell, the Last Homely House

Known details:
- Hidden valley in the Misty Mountains
- Elven refuge founded by Elrond
- Waterfalls, pine trees, ancient stone buildings
- A place of rest, learning, and healing
- Twilight atmosphere, stars visible even at dusk

Context: First arrival of weary travelers seeking sanctuary</textarea>
      </div>

      <div class="pane">
        <h2>General Style</h2>
        <textarea id="style-input" placeholder="Style rules that apply to your whole project...

Example:
- First person POV
- Past tense
- Spare, grounded prose
- Avoid adverbs
- Show don't tell">- First person POV from Bilbo
- Past tense
- Spare, grounded prose style
- Avoid purple prose or overly ornate language
- Show don't tell</textarea>
      </div>
    </div>

    <div class="input-section" style="margin-top: -10px;">
      <div class="pane" style="grid-column: 1 / -1;">
        <h2>This Scene</h2>
        <textarea id="scene-input" placeholder="What this specific scene should accomplish...

Example:
- Build tension before the reveal
- Convey exhaustion and relief
- Foreshadow the danger ahead">- Convey sense of relief and safety after danger
- Show the otherworldly, timeless quality of the Elves
- Use sensory details beyond just visual
- Length: 2-3 paragraphs</textarea>
      </div>
    </div>

    <!-- Style Guide Section -->
    <div class="style-guide" id="style-guide">
      <div class="style-guide-header" id="style-guide-header">
        <h2>Style Guide <span class="rule-count" id="rule-count"></span></h2>
        <span class="toggle-icon" id="toggle-icon">expand</span>
      </div>
      <div class="style-guide-content" id="style-guide-content">
        <p class="empty-message">No style rules yet. Select text in alternatives and drill down to crystallize your preferences.</p>
        <div class="rules-list" id="rules-list"></div>
      </div>
    </div>

    <div class="alternatives-header">
      <h2>Alternatives</h2>
      <button class="regenerate-btn">Generate More</button>
    </div>

    <div class="alternatives-grid" id="alternatives">
    </div>

    <div class="style-palette" id="style-palette">
      <div class="style-palette-header">
        <h2>Style Properties</h2>
        <span class="selection-count" id="style-selection-count"></span>
      </div>
      <div class="style-categories" id="style-categories">
      </div>
      <div class="panel-actions">
        <button class="action-btn primary" id="generate-from-styles" disabled>Generate with Selected Styles</button>
        <button class="action-btn clear-styles-btn" id="clear-styles" disabled>Clear Selection</button>
      </div>
    </div>

    <div class="reactions-panel" id="reactions-panel">
      <h2>My Reactions</h2>
      <div class="all-reactions" id="all-reactions">
        <p class="empty-state">Select text or add reactions to alternatives to collect your thoughts here.</p>
      </div>
      <div class="panel-actions">
        <button class="action-btn" id="apply-to-guidance" disabled>Apply to Guidance</button>
        <button class="action-btn primary" id="generate-with-reactions" disabled>Generate New Version</button>
      </div>
    </div>
  </div>

  <!-- Selection popup (hidden by default) -->
  <div class="selection-popup" id="selection-popup">
    <div class="selected-text" id="popup-selected-text"></div>
    <textarea id="popup-reaction-input" placeholder="What do you think about this?"></textarea>
    <div class="popup-actions">
      <button class="action-btn" id="popup-cancel">Cancel</button>
      <button class="action-btn" id="popup-drill-down">Drill Down</button>
      <button class="action-btn primary" id="popup-save">Add Reaction</button>
    </div>
  </div>

  <!-- Drill-down modal -->
  <div class="modal-overlay" id="drill-down-overlay">
    <div class="drill-down-modal">
      <div class="modal-header">
        <h3>Exploring Style</h3>
        <button class="close-modal" id="close-drill-down">&times;</button>
      </div>
      <div class="modal-body">
        <div class="selected-text-box" id="modal-selected-text"></div>
        <div class="initial-reaction-box">
          <label>Your initial reaction</label>
          <div id="modal-initial-reaction"></div>
        </div>
        <div class="conversation-area">
          <div class="conversation-messages" id="conversation-messages">
          </div>
        </div>
        <div class="conversation-input">
          <textarea id="coach-input" placeholder="Type your response..."></textarea>
          <button class="action-btn primary" id="send-to-coach">Send</button>
        </div>
        <div class="proposed-rule" id="proposed-rule">
          <h4>Proposed Style Rule</h4>
          <div class="rule-preview" id="rule-preview">
            <div class="principle" id="preview-principle"></div>
            <div class="examples" id="preview-examples"></div>
          </div>
          <textarea id="rule-edit-area" placeholder="Edit the rule..."></textarea>
          <div style="display: flex; gap: 10px;">
            <button class="action-btn" id="edit-rule-btn">Edit</button>
            <button class="action-btn" id="save-rule-edit" style="display: none;">Done Editing</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="action-btn" id="keep-exploring">Keep Exploring</button>
        <button class="action-btn primary" id="add-to-style-guide" disabled>Add to Style Guide</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Settings & LLM Configuration
    // ============================================

    const DEFAULT_SETTINGS = {
      provider: 'local',
      localUrl: 'http://localhost:1234',
      anthropicKey: ''
    };

    let settings = { ...DEFAULT_SETTINGS };
    let isGenerating = false;

    function loadSettings() {
      const saved = localStorage.getItem('writingStyleSettings');
      if (saved) {
        settings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
      }
      applySettingsToUI();
    }

    function saveSettings() {
      settings.provider = document.querySelector('input[name="provider"]:checked').value;
      settings.localUrl = document.getElementById('local-url').value;
      settings.anthropicKey = document.getElementById('anthropic-key').value;
      localStorage.setItem('writingStyleSettings', JSON.stringify(settings));
      showSettingsStatus('Settings saved', 'success');
    }

    function applySettingsToUI() {
      document.querySelector(`input[name="provider"][value="${settings.provider}"]`).checked = true;
      document.getElementById('local-url').value = settings.localUrl;
      document.getElementById('anthropic-key').value = settings.anthropicKey;
      updateProviderUI();
    }

    function updateProviderUI() {
      const provider = document.querySelector('input[name="provider"]:checked').value;
      document.getElementById('local-settings').style.display = provider === 'local' ? 'block' : 'none';
      document.getElementById('anthropic-settings').style.display = provider === 'anthropic' ? 'block' : 'none';
    }

    function showSettingsStatus(message, type) {
      const status = document.getElementById('settings-status');
      status.textContent = message;
      status.className = `settings-status ${type}`;
      status.style.display = 'block';
      setTimeout(() => { status.style.display = 'none'; }, 3000);
    }

    async function testConnection() {
      const provider = document.querySelector('input[name="provider"]:checked').value;

      try {
        if (provider === 'local') {
          const url = document.getElementById('local-url').value;
          const response = await fetch(`${url}/v1/models`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          if (response.ok) {
            const data = await response.json();
            const modelName = data.data?.[0]?.id || 'Unknown model';
            showSettingsStatus(`Connected! Model: ${modelName}`, 'success');
            document.getElementById('settings-toggle').classList.add('connected');
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } else {
          const key = document.getElementById('anthropic-key').value;
          if (!key) {
            showSettingsStatus('Please enter an API key', 'error');
            return;
          }
          // For Anthropic, we can't easily test without making a real request
          // Just validate the key format
          if (key.startsWith('sk-ant-')) {
            showSettingsStatus('API key format looks valid', 'success');
            document.getElementById('settings-toggle').classList.add('connected');
          } else {
            showSettingsStatus('API key should start with sk-ant-', 'warning');
          }
        }
      } catch (e) {
        let message = e.message;
        if (e.message === 'Failed to fetch' || e.message.includes('Load failed')) {
          message = 'CORS error - Enable CORS in LM Studio settings, or serve this file via a local server';
        }
        showSettingsStatus(`Connection failed: ${message}`, 'error');
        document.getElementById('settings-toggle').classList.remove('connected');
      }
    }

    // ============================================
    // LLM API Calls
    // ============================================

    async function callLLM(prompt, systemPrompt = '') {
      const provider = settings.provider;

      if (provider === 'local') {
        return callLocalLLM(prompt, systemPrompt);
      } else {
        return callAnthropicLLM(prompt, systemPrompt);
      }
    }

    async function callLocalLLM(prompt, systemPrompt) {
      // Combine system prompt into user message for better compatibility
      const fullPrompt = systemPrompt
        ? `${systemPrompt}\n\n---\n\n${prompt}`
        : prompt;

      const body = {
        messages: [
          { role: 'user', content: fullPrompt }
        ],
        temperature: 0.7,
        max_tokens: 1000,
        stream: false
      };

      console.log('LLM request:', body);

      const response = await fetch(`${settings.localUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('LLM error response:', errorText);
        throw new Error(`LLM request failed: ${response.status} - ${errorText}`);
      }

      const data = await response.json();
      console.log('LLM response:', data);
      return data.choices[0].message.content;
    }

    async function callAnthropicLLM(prompt, systemPrompt) {
      // Note: This won't work directly from browser due to CORS
      // User would need to use a proxy or the Anthropic API allows browser requests
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': settings.anthropicKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-3-haiku-20240307',
          max_tokens: 2000,
          system: systemPrompt || undefined,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || `API request failed: ${response.status}`);
      }

      const data = await response.json();
      return data.content[0].text;
    }

    // ============================================
    // Generation Functions
    // ============================================

    function getSettingInput() {
      return document.getElementById('setting-input').value;
    }

    function getStyleInput() {
      return document.getElementById('style-input').value;
    }

    function getSceneInput() {
      return document.getElementById('scene-input').value;
    }

    function getGuidanceInput() {
      const style = getStyleInput().trim();
      const scene = getSceneInput().trim();

      let guidance = '';
      if (style) {
        guidance += `General style rules:\n${style}`;
      }
      if (scene) {
        if (guidance) guidance += '\n\n';
        guidance += `For this scene:\n${scene}`;
      }
      return guidance;
    }

    const SYSTEM_PROMPT = `You are a creative writing assistant specializing in prose style and description. You help writers explore different ways to describe settings, finding the voice and style that resonates with them.

When generating descriptions:
- Focus on craft and style, not just content
- Vary your approach based on the style properties requested
- Be specific and evocative
- Avoid clichés unless specifically requested
- Match the requested length closely

When asked to describe your stylistic choices, use brief, specific labels (1-3 words each) for tone, technique, and pacing.`;

    function getStyleGuideText() {
      if (styleGuide.length === 0) return '';

      const rulesText = styleGuide.map(rule => {
        let text = `- ${rule.principle}`;
        if (rule.originalExample && rule.betterVersion) {
          text += `\n  NOT: "${rule.originalExample}"`;
          text += `\n  BETTER: "${rule.betterVersion}"`;
        }
        if (rule.avoid && rule.avoid.length > 0) {
          text += `\n  Avoid patterns like: ${rule.avoid.join(', ')}`;
        }
        if (rule.prefer && rule.prefer.length > 0) {
          text += `\n  Prefer patterns like: ${rule.prefer.join(', ')}`;
        }
        return text;
      }).join('\n');

      return `\nStyle rules from the author (follow these strictly):
${rulesText}
`;
    }

    function buildGenerationPrompt(settingInfo, guidance, additionalInstructions = '') {
      const styleGuideText = getStyleGuideText();

      return `Write a description of the following setting:

${settingInfo}

Writing guidance from the author:
${guidance}
${styleGuideText}
${additionalInstructions}

First, output a JSON line with style tags, then the description. Format:
{"tone": "word", "technique": "phrase", "pacing": "word"}

Then write the description (2-3 paragraphs unless otherwise specified).`;
    }

    function parseGeneratedResponse(response) {
      // Try to extract JSON tags and description
      const lines = response.trim().split('\n');
      let tags = { tone: 'varied', technique: 'mixed', pacing: 'moderate' };
      let textStartIndex = 0;

      // Look for JSON in first few lines
      for (let i = 0; i < Math.min(3, lines.length); i++) {
        try {
          const jsonMatch = lines[i].match(/\{[^}]+\}/);
          if (jsonMatch) {
            tags = JSON.parse(jsonMatch[0]);
            textStartIndex = i + 1;
            break;
          }
        } catch (e) {
          // Not valid JSON, continue
        }
      }

      const text = lines.slice(textStartIndex).join('\n').trim();

      return {
        tags: [
          { text: tags.tone || 'varied', type: 'tone' },
          { text: tags.technique || 'mixed', type: 'technique' },
          { text: tags.pacing || 'moderate', type: 'pacing' }
        ],
        text: text || response // Fallback to full response if parsing failed
      };
    }

    async function generateAlternatives(count = 2, additionalInstructions = '') {
      if (isGenerating) return;
      isGenerating = true;

      const settingInfo = getSettingInput();
      const guidance = getGuidanceInput();

      if (!settingInfo.trim()) {
        alert('Please describe what you want to write about in the "What I\'m Describing" pane.');
        isGenerating = false;
        return;
      }

      // Show loading state
      const container = document.getElementById('alternatives');
      const existingContent = container.innerHTML;

      // Add loading placeholders
      for (let i = 0; i < count; i++) {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'alternative loading';
        loadingDiv.innerHTML = '<span class="loading-indicator"></span> Generating...';
        container.appendChild(loadingDiv);
      }

      try {
        const prompt = buildGenerationPrompt(settingInfo, guidance, additionalInstructions);

        // Generate multiple alternatives
        const promises = [];
        for (let i = 0; i < count; i++) {
          promises.push(callLLM(prompt, SYSTEM_PROMPT));
        }

        const results = await Promise.all(promises);

        // Remove loading placeholders
        container.querySelectorAll('.alternative.loading').forEach(el => el.remove());

        // Add new alternatives
        results.forEach((response, i) => {
          const parsed = parseGeneratedResponse(response);
          const newAlt = {
            id: `alt-${Date.now()}-${i}`,
            tags: parsed.tags,
            text: parsed.text
          };
          alternatives.push(newAlt);
        });

        renderAlternatives();
      } catch (e) {
        // Remove loading placeholders
        container.querySelectorAll('.alternative.loading').forEach(el => el.remove());
        alert(`Generation failed: ${e.message}\n\nMake sure LM Studio is running with a model loaded.`);
      }

      isGenerating = false;
    }

    async function generateWithStyles() {
      const stylesArray = Array.from(selectedStyles);
      if (stylesArray.length === 0) return;

      const instructions = `Apply these specific style properties:
${stylesArray.map(s => `- ${s}`).join('\n')}

Make sure the description clearly embodies these stylistic choices.`;

      await generateAlternatives(1, instructions);
    }

    async function generateWithReactions() {
      if (reactions.length === 0) return;

      const reactionText = reactions.map(r => {
        if (r.quote) {
          return `Regarding "${r.quote}": ${r.text}`;
        }
        return r.text;
      }).join('\n');

      const instructions = `The writer has provided this feedback on previous attempts:
${reactionText}

Use this feedback to create an improved version that addresses their concerns and preferences.`;

      await generateAlternatives(1, instructions);
    }

    // ============================================
    // Hard-coded initial alternatives (for demo)
    // ============================================

    const alternatives = [
      {
        id: 'alt-1',
        tags: [
          { text: "immersive", type: "tone" },
          { text: "sensory layering", type: "technique" },
          { text: "measured", type: "pacing" }
        ],
        text: `The sound reached them before the sight—water falling, not crashing but singing, a chord sustained across centuries. The path curved and suddenly the valley opened below, terraced with gardens that climbed toward buildings of pale stone, their windows catching the last copper light of sunset.

Bilbo found he had stopped walking. The air here tasted different. Cleaner, yes, but also older, as if each breath carried the memory of a thousand springs. Somewhere below, someone was playing a harp, the notes drifting up like wood smoke.

"The Last Homely House," Gandalf said, and for once his voice held no irony. Even wizards, it seemed, could feel relief.`
      },
      {
        id: 'alt-2',
        tags: [
          { text: "spare", type: "tone" },
          { text: "character-anchored", type: "technique" },
          { text: "quick", type: "pacing" }
        ],
        text: `They came down into the valley at dusk. Waterfalls on three sides. Stone buildings older than any Bilbo had seen, though they wore their age lightly. Elves moved among the lamplit paths, unhurried, paying the travelers no particular attention.

Bilbo's feet had stopped hurting somewhere on the descent. He noticed this only now. The whole place seemed to insist, gently, that urgency was a choice—and not a particularly wise one.`
      },
      {
        id: 'alt-3',
        tags: [
          { text: "lyrical", type: "tone" },
          { text: "extended metaphor", type: "technique" },
          { text: "contemplative", type: "pacing" }
        ],
        text: `Rivendell lay in its valley like a held breath. The mountains cupped it in grey palms, and waterfalls threaded down their fingers, catching light that seemed borrowed from some gentler age. Here, the world had decided to pause—and having paused, had forgotten to resume.

The buildings rose from the living rock as if they had grown rather than been built, their windows glowing amber against the deepening blue of evening. Music drifted from somewhere, or perhaps from everywhere, a sound so woven into the air that silence here would have felt like a missing limb.

Bilbo stood at the valley's edge and felt something loosen in his chest. Not safety, exactly. Something older than safety. The sense of a place that had been waiting, that would go on waiting, long after the current troubles had become old songs sung by the fire.`
      },
      {
        id: 'alt-4',
        tags: [
          { text: "grounded", type: "tone" },
          { text: "contrast", type: "technique" },
          { text: "steady", type: "pacing" }
        ],
        text: `After the goblin tunnels, after Gollum's cave, after the long stumbling descent through pine forests that all looked alike—this. Rivendell opened before them like an answered prayer, though Bilbo had never been one for praying.

Terraced gardens. Waterfalls that caught the evening light. Stone buildings with windows of colored glass, and everywhere the sound of water and distant voices raised in song. The air smelled of pine and something sweeter, honeysuckle perhaps, though it was too late in the year for honeysuckle.

His companions were already heading down the path, but Bilbo lingered. He had the strangest feeling that once he entered this valley, he would not leave it quite the same hobbit who had arrived.`
      }
    ];

    // Style properties organized by category
    const styleProperties = {
      "Tone": [
        "immersive", "spare", "lyrical", "grounded", "intimate", "distant",
        "warm", "cool", "reverent", "irreverent", "earnest", "wry",
        "somber", "playful", "nostalgic", "urgent"
      ],
      "Pacing": [
        "measured", "quick", "contemplative", "steady", "staccato", "flowing",
        "languid", "brisk", "unhurried", "breathless"
      ],
      "Technique": [
        "sensory layering", "character-anchored", "extended metaphor", "contrast",
        "accumulation", "fragmentation", "parallel structure", "delayed reveal",
        "in medias res", "close observation", "impressionistic", "cinematic"
      ],
      "Sensory Focus": [
        "visual", "auditory", "tactile", "olfactory", "kinesthetic",
        "synesthetic", "temperature", "texture"
      ],
      "Perspective": [
        "close third", "distant third", "first person", "omniscient",
        "present tense", "past tense", "direct", "filtered"
      ],
      "Mood": [
        "mysterious", "peaceful", "tense", "melancholy", "hopeful",
        "ominous", "serene", "unsettling", "wonder", "bittersweet"
      ],
      "Structure": [
        "fragments", "long sentences", "varied rhythm", "repetition",
        "list-like", "nested clauses", "simple declarative", "question-driven"
      ]
    };

    // Selected styles
    let selectedStyles = new Set();

    // Style Guide - persisted per project
    let styleGuide = [];
    let styleGuideExpanded = false;

    function loadStyleGuide() {
      const saved = localStorage.getItem('writingStyleGuide');
      if (saved) {
        styleGuide = JSON.parse(saved);
      }
      renderStyleGuide();
    }

    function saveStyleGuide() {
      localStorage.setItem('writingStyleGuide', JSON.stringify(styleGuide));
      renderStyleGuide();
    }

    function addStyleRule(rule) {
      styleGuide.push({
        id: `rule-${Date.now()}`,
        ...rule
      });
      saveStyleGuide();
    }

    function removeStyleRule(ruleId) {
      styleGuide = styleGuide.filter(r => r.id !== ruleId);
      saveStyleGuide();
    }

    function renderStyleGuide() {
      const countEl = document.getElementById('rule-count');
      const contentEl = document.getElementById('style-guide-content');
      const rulesListEl = document.getElementById('rules-list');
      const emptyMsg = contentEl.querySelector('.empty-message');
      const guideEl = document.getElementById('style-guide');

      countEl.textContent = styleGuide.length > 0 ? `(${styleGuide.length} rules)` : '';

      if (styleGuide.length === 0) {
        guideEl.classList.add('empty');
        emptyMsg.style.display = 'block';
        rulesListEl.innerHTML = '';
      } else {
        guideEl.classList.remove('empty');
        emptyMsg.style.display = 'none';
        rulesListEl.innerHTML = styleGuide.map(rule => `
          <div class="style-rule" data-rule-id="${rule.id}">
            <div class="rule-actions">
              <button class="edit" data-rule-id="${rule.id}" title="Edit">edit</button>
              <button class="remove" data-rule-id="${rule.id}" title="Remove">&times;</button>
            </div>
            <div class="rule-display">
              <div class="rule-principle">${escapeHtml(rule.principle)}</div>
              ${rule.originalExample ? `
                <div class="rule-original">
                  <span class="example-label">Example:</span> "${escapeHtml(rule.originalExample)}"
                  ${rule.betterVersion ? `<br><span class="example-label">Better:</span> "${escapeHtml(rule.betterVersion)}"` : ''}
                </div>
              ` : ''}
              <div class="rule-examples">
                ${rule.avoid && rule.avoid.length > 0 ? `<span class="avoid">Avoid: ${rule.avoid.join(', ')}</span>` : ''}
                ${rule.avoid && rule.avoid.length > 0 && rule.prefer && rule.prefer.length > 0 ? ' | ' : ''}
                ${rule.prefer && rule.prefer.length > 0 ? `<span class="prefer">Prefer: ${rule.prefer.join(', ')}</span>` : ''}
              </div>
            </div>
            <div class="edit-form">
              <label>Principle</label>
              <input type="text" class="edit-principle" value="${escapeHtml(rule.principle || '')}">
              <label>Original Example</label>
              <textarea class="edit-original">${escapeHtml(rule.originalExample || '')}</textarea>
              <label>Better Version</label>
              <textarea class="edit-better">${escapeHtml(rule.betterVersion || '')}</textarea>
              <label>Avoid (comma-separated)</label>
              <input type="text" class="edit-avoid" value="${escapeHtml((rule.avoid || []).join(', '))}">
              <label>Prefer (comma-separated)</label>
              <input type="text" class="edit-prefer" value="${escapeHtml((rule.prefer || []).join(', '))}">
              <div class="edit-actions">
                <button class="action-btn cancel-edit" data-rule-id="${rule.id}">Cancel</button>
                <button class="action-btn primary save-edit" data-rule-id="${rule.id}">Save</button>
              </div>
            </div>
          </div>
        `).join('');

        // Add event listeners
        rulesListEl.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeStyleRule(e.target.dataset.ruleId);
          });
        });

        rulesListEl.querySelectorAll('.edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const ruleEl = e.target.closest('.style-rule');
            ruleEl.classList.add('editing');
          });
        });

        rulesListEl.querySelectorAll('.cancel-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const ruleEl = e.target.closest('.style-rule');
            ruleEl.classList.remove('editing');
            renderStyleGuide(); // Reset form values
          });
        });

        rulesListEl.querySelectorAll('.save-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const ruleId = e.target.dataset.ruleId;
            const ruleEl = e.target.closest('.style-rule');
            saveRuleEdit(ruleId, ruleEl);
          });
        });
      }
    }

    function saveRuleEdit(ruleId, ruleEl) {
      const rule = styleGuide.find(r => r.id === ruleId);
      if (!rule) return;

      rule.principle = ruleEl.querySelector('.edit-principle').value.trim();
      rule.originalExample = ruleEl.querySelector('.edit-original').value.trim() || null;
      rule.betterVersion = ruleEl.querySelector('.edit-better').value.trim() || null;

      const avoidStr = ruleEl.querySelector('.edit-avoid').value.trim();
      rule.avoid = avoidStr ? avoidStr.split(',').map(s => s.trim()).filter(s => s) : [];

      const preferStr = ruleEl.querySelector('.edit-prefer').value.trim();
      rule.prefer = preferStr ? preferStr.split(',').map(s => s.trim()).filter(s => s) : [];

      saveStyleGuide();
    }

    function toggleStyleGuide() {
      const contentEl = document.getElementById('style-guide-content');
      const toggleIcon = document.getElementById('toggle-icon');
      styleGuideExpanded = !styleGuideExpanded;
      contentEl.classList.toggle('expanded', styleGuideExpanded);
      toggleIcon.textContent = styleGuideExpanded ? 'collapse' : 'expand';
    }

    // Drill-down modal state
    let drillDownState = {
      selectedText: '',
      initialReaction: '',
      alternativeId: null,
      conversation: [],
      proposedRule: null
    };

    // Store all reactions
    let reactions = [];
    let reactionIdCounter = 0;

    // Current selection state
    let currentSelection = {
      text: '',
      alternativeId: null
    };

    function renderAlternatives() {
      const container = document.getElementById('alternatives');
      container.innerHTML = alternatives.map((alt, index) => `
        <div class="alternative${index === 0 ? ' selected' : ''}" data-alt-id="${alt.id}">
          <button class="remove-alternative" data-alt-id="${alt.id}" title="Remove">&times;</button>
          <div class="style-tags">
            ${alt.tags.map(tag => `<span class="tag ${tag.type}">${tag.text}</span>`).join('')}
          </div>
          <div class="description-text" data-alt-id="${alt.id}">
            ${alt.text.split('\n\n').map(p => `<p>${p}</p>`).join('')}
          </div>
          <div class="reaction-input">
            <div class="input-row">
              <textarea placeholder="Your reaction to this version..." data-alt-id="${alt.id}"></textarea>
              <button class="action-btn add-reaction-btn" data-alt-id="${alt.id}">Add</button>
            </div>
            <div class="reactions-list" data-alt-id="${alt.id}"></div>
          </div>
          <div class="alternative-actions">
            <button class="action-btn primary">Use This</button>
            <button class="action-btn">Vary This</button>
            <button class="action-btn">More Like This</button>
          </div>
        </div>
      `).join('');

      // Add event listeners for reaction buttons
      document.querySelectorAll('.add-reaction-btn').forEach(btn => {
        btn.addEventListener('click', handleAddReaction);
      });

      // Add event listeners for text selection
      document.querySelectorAll('.description-text').forEach(el => {
        el.addEventListener('mouseup', handleTextSelection);
      });

      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-alternative').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const altId = e.target.dataset.altId;
          removeAlternative(altId);
        });
      });
    }

    function removeAlternative(altId) {
      const index = alternatives.findIndex(a => a.id === altId);
      if (index !== -1) {
        alternatives.splice(index, 1);
        // Also remove any reactions for this alternative
        reactions = reactions.filter(r => r.alternativeId !== altId);
        renderAlternatives();
        renderAllReactions();
        updatePanelButtons();
      }
    }

    function handleAddReaction(e) {
      const altId = e.target.dataset.altId;
      const textarea = document.querySelector(`.reaction-input textarea[data-alt-id="${altId}"]`);
      const text = textarea.value.trim();

      if (text) {
        addReaction({
          alternativeId: altId,
          quote: null,
          text: text
        });
        textarea.value = '';
        renderReactionsForAlternative(altId);
        renderAllReactions();
      }
    }

    function handleTextSelection(e) {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText.length > 0) {
        const altId = e.currentTarget.dataset.altId;
        currentSelection = {
          text: selectedText,
          alternativeId: altId
        };
        showSelectionPopup(e);
      }
    }

    function showSelectionPopup(e) {
      const popup = document.getElementById('selection-popup');
      const selectedTextEl = document.getElementById('popup-selected-text');
      const inputEl = document.getElementById('popup-reaction-input');

      // Show the selected text (truncated if too long)
      const displayText = currentSelection.text.length > 100
        ? currentSelection.text.substring(0, 100) + '...'
        : currentSelection.text;
      selectedTextEl.textContent = `"${displayText}"`;

      // Position the popup near the selection
      const rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
      popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
      popup.style.left = `${Math.min(rect.left + window.scrollX, window.innerWidth - 300)}px`;

      popup.classList.add('visible');
      inputEl.value = '';
      inputEl.focus();
    }

    function hideSelectionPopup() {
      const popup = document.getElementById('selection-popup');
      popup.classList.remove('visible');
      currentSelection = { text: '', alternativeId: null };
    }

    function addReaction(reaction) {
      reactions.push({
        id: ++reactionIdCounter,
        ...reaction
      });
      updatePanelButtons();
    }

    function removeReaction(id) {
      reactions = reactions.filter(r => r.id !== id);
      // Re-render reactions for all alternatives
      alternatives.forEach(alt => renderReactionsForAlternative(alt.id));
      renderAllReactions();
      updatePanelButtons();
    }

    function renderReactionsForAlternative(altId) {
      const container = document.querySelector(`.reactions-list[data-alt-id="${altId}"]`);
      const altReactions = reactions.filter(r => r.alternativeId === altId);

      container.innerHTML = altReactions.map(r => `
        <div class="reaction-item">
          <button class="remove-reaction" data-reaction-id="${r.id}">&times;</button>
          ${r.quote ? `<div class="reaction-quote">"${truncate(r.quote, 80)}"</div>` : ''}
          <div class="reaction-text">${r.text}</div>
        </div>
      `).join('');

      // Add remove listeners
      container.querySelectorAll('.remove-reaction').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeReaction(parseInt(e.target.dataset.reactionId));
        });
      });
    }

    function renderAllReactions() {
      const container = document.getElementById('all-reactions');

      if (reactions.length === 0) {
        container.innerHTML = '<p class="empty-state">Select text or add reactions to alternatives to collect your thoughts here.</p>';
        return;
      }

      container.innerHTML = reactions.map(r => {
        const alt = alternatives.find(a => a.id === r.alternativeId);
        const altLabel = alt ? alt.tags[0].text : 'Unknown';
        return `
          <div class="reaction-item">
            <button class="remove-reaction" data-reaction-id="${r.id}">&times;</button>
            <div class="source-label">On "${altLabel}" version</div>
            ${r.quote ? `<div class="reaction-quote">"${truncate(r.quote, 80)}"</div>` : ''}
            <div class="reaction-text">${r.text}</div>
          </div>
        `;
      }).join('');

      // Add remove listeners
      container.querySelectorAll('.remove-reaction').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeReaction(parseInt(e.target.dataset.reactionId));
        });
      });
    }

    function updatePanelButtons() {
      const applyBtn = document.getElementById('apply-to-guidance');
      const generateBtn = document.getElementById('generate-with-reactions');
      const hasReactions = reactions.length > 0;

      applyBtn.disabled = !hasReactions;
      generateBtn.disabled = !hasReactions;
    }

    function truncate(str, maxLength) {
      return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
    }

    // Style palette functions
    function renderStylePalette() {
      const container = document.getElementById('style-categories');
      container.innerHTML = Object.entries(styleProperties).map(([category, options]) => `
        <div class="style-category">
          <h3>${category}</h3>
          <div class="style-options">
            ${options.map(opt => `
              <span class="style-option${selectedStyles.has(opt) ? ' selected' : ''}" data-style="${opt}">
                ${opt}
              </span>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Add click listeners
      container.querySelectorAll('.style-option').forEach(el => {
        el.addEventListener('click', () => toggleStyle(el.dataset.style));
      });

      updateStyleSelectionCount();
    }

    function toggleStyle(style) {
      if (selectedStyles.has(style)) {
        selectedStyles.delete(style);
      } else {
        selectedStyles.add(style);
      }
      renderStylePalette();
    }

    function updateStyleSelectionCount() {
      const countEl = document.getElementById('style-selection-count');
      const generateBtn = document.getElementById('generate-from-styles');
      const clearBtn = document.getElementById('clear-styles');
      const count = selectedStyles.size;

      if (count === 0) {
        countEl.textContent = '';
        generateBtn.disabled = true;
        clearBtn.disabled = true;
      } else {
        countEl.textContent = `${count} selected`;
        generateBtn.disabled = false;
        clearBtn.disabled = false;
      }
    }

    function clearStyles() {
      selectedStyles.clear();
      renderStylePalette();
    }

    // ============================================
    // Drill-Down Modal & Coach
    // ============================================

    const COACH_SYSTEM_PROMPT = `You are a writing coach helping a writer articulate their stylistic preferences. Your role is to:

1. Ask clarifying questions to help them understand WHY they react to certain writing choices
2. Use specific terminology for writing concepts when helpful (e.g., "filtering", "purple prose", "show don't tell")
3. Be curious and non-judgmental - there are no wrong preferences
4. Help them move from vague feelings ("I don't like this") to specific principles ("Avoid naming emotions directly")
5. After 2-3 exchanges, propose a crystallized style rule

When proposing a rule, format it as JSON on a single line:
{"principle": "Short rule description", "avoid": ["example phrase to avoid"], "prefer": ["preferred alternative"], "betterVersion": "a rewrite of the original text following this rule"}

The betterVersion should be a concrete rewrite of the specific text they selected, demonstrating the principle.

Keep your responses concise (2-3 sentences for questions, slightly longer when proposing rules).`;

    function openDrillDown(selectedText, initialReaction, alternativeId) {
      drillDownState = {
        selectedText,
        initialReaction,
        alternativeId,
        conversation: [],
        proposedRule: null
      };

      // Update modal UI
      document.getElementById('modal-selected-text').textContent = `"${selectedText}"`;
      document.getElementById('modal-initial-reaction').textContent = initialReaction || '(no initial reaction)';
      document.getElementById('conversation-messages').innerHTML = '';
      document.getElementById('coach-input').value = '';
      document.getElementById('proposed-rule').classList.remove('visible');
      document.getElementById('add-to-style-guide').disabled = true;

      // Show modal
      document.getElementById('drill-down-overlay').classList.add('visible');

      // Start the coaching conversation
      startCoachConversation();
    }

    function closeDrillDown() {
      document.getElementById('drill-down-overlay').classList.remove('visible');
      drillDownState = {
        selectedText: '',
        initialReaction: '',
        alternativeId: null,
        conversation: [],
        proposedRule: null
      };
    }

    async function startCoachConversation() {
      const prompt = `The writer selected this text from a description:
"${drillDownState.selectedText}"

Their initial reaction: "${drillDownState.initialReaction || 'They want to explore why this doesn\'t work for them'}"

Ask ONE short question (1-2 sentences) to help them articulate what specifically they react to. Offer 2-3 specific possibilities. Do not include any meta-instructions in your response.`;

      try {
        let response = await callLLM(prompt, COACH_SYSTEM_PROMPT);
        // Clean up any echoed instructions
        response = response.replace(/Do not include.*$/gm, '').trim();
        addCoachMessage(response);
      } catch (e) {
        addCoachMessage("I'd love to help you explore this. What specifically bothers you about this passage - is it the word choice, the rhythm, or the idea being expressed?");
      }
    }

    async function sendToCoach() {
      const input = document.getElementById('coach-input');
      const userMessage = input.value.trim();
      if (!userMessage) return;

      // Add user message
      addUserMessage(userMessage);
      input.value = '';

      // Build conversation history for context - just the messages, clearly formatted
      const conversationText = drillDownState.conversation
        .map(m => `${m.role === 'user' ? 'WRITER' : 'COACH'}: ${m.content}`)
        .join('\n\n');

      const shouldPropose = drillDownState.conversation.length >= 4;

      const prompt = `You are helping a writer explore their reaction to this text:
"${drillDownState.selectedText}"

Their initial reaction: "${drillDownState.initialReaction || 'wants to explore'}"

CONVERSATION:
${conversationText}

YOUR TASK: ${shouldPropose
  ? 'Based on the conversation, propose a style rule. Output ONLY the JSON rule, nothing else: {"principle": "...", "avoid": [...], "prefer": [...]}'
  : 'Ask ONE short clarifying question (1-2 sentences max) to help them articulate their preference. Do not repeat what they said. Do not include any instructions in your response.'}`;

      try {
        let response = await callLLM(prompt, COACH_SYSTEM_PROMPT);

        // Clean up response - remove any echoed instructions or conversation
        response = response
          .replace(/^(WRITER|COACH|Writer|Coach):\s*/gm, '')
          .replace(/Continue helping.*$/gm, '')
          .replace(/Ask another question.*$/gm, '')
          .replace(/YOUR TASK:.*$/gm, '')
          .replace(/CONVERSATION:.*$/gm, '')
          .trim();

        addCoachMessage(response);

        // Check if response contains a proposed rule
        const ruleMatch = response.match(/\{[^}]*"principle"[^}]*\}/);
        if (ruleMatch) {
          try {
            const rule = JSON.parse(ruleMatch[0]);
            showProposedRule(rule);
          } catch (e) {
            // Couldn't parse rule, continue conversation
          }
        }
      } catch (e) {
        addCoachMessage("I'm having trouble connecting. Could you tell me more about what you're looking for in this description?");
      }
    }

    function addUserMessage(content) {
      drillDownState.conversation.push({ role: 'user', content });
      const messagesEl = document.getElementById('conversation-messages');
      messagesEl.innerHTML += `
        <div class="conv-message user">
          <span class="speaker">You</span>
          <div class="content">${escapeHtml(content)}</div>
        </div>
      `;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addCoachMessage(content) {
      drillDownState.conversation.push({ role: 'coach', content });
      const messagesEl = document.getElementById('conversation-messages');

      // Strip out any JSON from display
      const displayContent = content.replace(/\{[^}]*"principle"[^}]*\}/g, '').trim();

      if (displayContent) {
        messagesEl.innerHTML += `
          <div class="conv-message coach">
            <span class="speaker">Coach</span>
            <div class="content">${escapeHtml(displayContent)}</div>
          </div>
        `;
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showProposedRule(rule) {
      // Always include the original example from the drill-down
      rule.originalExample = drillDownState.selectedText;

      // If the LLM suggested a better version, include it
      if (rule.betterVersion) {
        // Already included
      }

      drillDownState.proposedRule = rule;

      const previewEl = document.getElementById('rule-preview');
      const principleEl = document.getElementById('preview-principle');
      const examplesEl = document.getElementById('preview-examples');

      principleEl.textContent = rule.principle || '';

      let examplesHtml = '';

      // Show original example
      if (rule.originalExample) {
        examplesHtml += `<div style="margin-bottom: 8px; font-style: italic; color: #666;">
          <span style="font-style: normal; color: #888;">Original:</span> "${escapeHtml(rule.originalExample)}"
        </div>`;
      }
      if (rule.betterVersion) {
        examplesHtml += `<div style="margin-bottom: 8px; font-style: italic; color: #5a5;">
          <span style="font-style: normal; color: #888;">Better:</span> "${escapeHtml(rule.betterVersion)}"
        </div>`;
      }

      if (rule.avoid && rule.avoid.length > 0) {
        examplesHtml += `<span class="avoid">Avoid: ${rule.avoid.join(', ')}</span>`;
      }
      if (rule.prefer && rule.prefer.length > 0) {
        if (rule.avoid && rule.avoid.length > 0) examplesHtml += '<br>';
        examplesHtml += `<span class="prefer">Prefer: ${rule.prefer.join(', ')}</span>`;
      }
      examplesEl.innerHTML = examplesHtml;

      document.getElementById('proposed-rule').classList.add('visible');
      document.getElementById('add-to-style-guide').disabled = false;
    }

    function toggleRuleEdit() {
      const previewEl = document.getElementById('rule-preview');
      const editArea = document.getElementById('rule-edit-area');
      const editBtn = document.getElementById('edit-rule-btn');
      const saveBtn = document.getElementById('save-rule-edit');

      if (editArea.style.display === 'none' || !editArea.style.display) {
        // Start editing
        editArea.value = JSON.stringify(drillDownState.proposedRule, null, 2);
        editArea.style.display = 'block';
        previewEl.style.display = 'none';
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
      } else {
        // Save edit
        try {
          drillDownState.proposedRule = JSON.parse(editArea.value);
          showProposedRule(drillDownState.proposedRule);
        } catch (e) {
          alert('Invalid JSON format');
          return;
        }
        editArea.style.display = 'none';
        previewEl.style.display = 'block';
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
      }
    }

    function addRuleToStyleGuide() {
      if (drillDownState.proposedRule) {
        addStyleRule(drillDownState.proposedRule);
        closeDrillDown();
        // Expand style guide to show new rule
        if (!styleGuideExpanded) {
          toggleStyleGuide();
        }
      }
    }

    // ============================================
    // Initialize
    // ============================================

    // Auto-resize textareas to fit content
    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    function setupAutoResize() {
      const textareas = document.querySelectorAll('#setting-input, #style-input, #scene-input');
      textareas.forEach(textarea => {
        autoResizeTextarea(textarea);
        textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      });
    }

    loadSettings();
    loadStyleGuide();
    renderAlternatives();
    renderAllReactions();
    renderStylePalette();
    setupAutoResize();

    // ============================================
    // Style Guide Event Listeners
    // ============================================

    document.getElementById('style-guide-header').addEventListener('click', toggleStyleGuide);

    // ============================================
    // Drill-Down Modal Event Listeners
    // ============================================

    document.getElementById('close-drill-down').addEventListener('click', closeDrillDown);

    document.getElementById('drill-down-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('drill-down-overlay')) {
        closeDrillDown();
      }
    });

    document.getElementById('send-to-coach').addEventListener('click', sendToCoach);

    document.getElementById('coach-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendToCoach();
      }
    });

    document.getElementById('edit-rule-btn').addEventListener('click', toggleRuleEdit);
    document.getElementById('save-rule-edit').addEventListener('click', toggleRuleEdit);

    document.getElementById('keep-exploring').addEventListener('click', () => {
      document.getElementById('proposed-rule').classList.remove('visible');
      document.getElementById('add-to-style-guide').disabled = true;
      drillDownState.proposedRule = null;
    });

    document.getElementById('add-to-style-guide').addEventListener('click', addRuleToStyleGuide);

    // ============================================
    // Settings Panel Event Listeners
    // ============================================

    document.getElementById('settings-toggle').addEventListener('click', () => {
      const panel = document.getElementById('settings-panel');
      panel.classList.toggle('visible');
    });

    document.querySelectorAll('input[name="provider"]').forEach(radio => {
      radio.addEventListener('change', updateProviderUI);
    });

    document.getElementById('test-connection').addEventListener('click', testConnection);
    document.getElementById('save-settings').addEventListener('click', saveSettings);

    // Close settings when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('settings-panel');
      const toggle = document.getElementById('settings-toggle');
      if (panel.classList.contains('visible') &&
          !panel.contains(e.target) &&
          !toggle.contains(e.target)) {
        panel.classList.remove('visible');
      }
    });

    // ============================================
    // Generation Button Event Listeners
    // ============================================

    document.querySelector('.regenerate-btn').addEventListener('click', () => {
      generateAlternatives(2);
    });

    document.getElementById('generate-from-styles').addEventListener('click', generateWithStyles);

    document.getElementById('generate-with-reactions').addEventListener('click', generateWithReactions);

    // ============================================
    // Popup Event Listeners
    // ============================================

    document.getElementById('popup-cancel').addEventListener('click', hideSelectionPopup);

    document.getElementById('popup-save').addEventListener('click', () => {
      const inputEl = document.getElementById('popup-reaction-input');
      const text = inputEl.value.trim();

      if (text && currentSelection.text) {
        addReaction({
          alternativeId: currentSelection.alternativeId,
          quote: currentSelection.text,
          text: text
        });
        renderReactionsForAlternative(currentSelection.alternativeId);
        renderAllReactions();
        hideSelectionPopup();
      }
    });

    document.getElementById('popup-drill-down').addEventListener('click', () => {
      const inputEl = document.getElementById('popup-reaction-input');
      const reactionText = inputEl.value.trim();

      if (currentSelection.text) {
        // Capture values before hideSelectionPopup clears them
        const selectedText = currentSelection.text;
        const altId = currentSelection.alternativeId;
        hideSelectionPopup();
        openDrillDown(selectedText, reactionText, altId);
      }
    });

    // Allow Enter to submit in popup
    document.getElementById('popup-reaction-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('popup-save').click();
      }
    });

    // Close popup when clicking outside
    document.addEventListener('mousedown', (e) => {
      const popup = document.getElementById('selection-popup');
      if (popup.classList.contains('visible') && !popup.contains(e.target)) {
        // Small delay to allow text selection to complete
        setTimeout(() => {
          if (!window.getSelection().toString().trim()) {
            hideSelectionPopup();
          }
        }, 100);
      }
    });

    // ============================================
    // Other Button Event Listeners
    // ============================================

    // Apply to Guidance button - adds reactions to scene guidance
    document.getElementById('apply-to-guidance').addEventListener('click', () => {
      const sceneEl = document.getElementById('scene-input');
      const reactionText = reactions.map(r => {
        if (r.quote) {
          return `- Re "${truncate(r.quote, 40)}": ${r.text}`;
        }
        return `- ${r.text}`;
      }).join('\n');

      sceneEl.value += '\n\nFeedback from reviewing alternatives:\n' + reactionText;
      autoResizeTextarea(sceneEl);
      alert('Reactions added to scene guidance!');
    });

    document.getElementById('clear-styles').addEventListener('click', clearStyles);

    // Auto-test connection on load if settings exist
    if (settings.provider === 'local') {
      testConnection().catch(() => {});
    }
  </script>
</body>
</html>
