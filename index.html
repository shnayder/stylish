<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Writing Style Explorer</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      margin: 0;
      padding: 20px;
      background: #f5f3ef;
      color: #2c2c2c;
      line-height: 1.6;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #3a3a3a;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .input-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .pane {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .pane h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    .pane-content {
      font-size: 0.95rem;
      color: #444;
    }

    .pane-content p {
      margin: 0 0 10px 0;
    }

    .pane-content ul {
      margin: 0;
      padding-left: 20px;
    }

    .pane-content li {
      margin-bottom: 6px;
    }

    .alternatives-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .alternatives-header h2 {
      font-size: 1.1rem;
      color: #3a3a3a;
      margin: 0;
    }

    .regenerate-btn {
      background: #5a7a5a;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .regenerate-btn:hover {
      background: #4a6a4a;
    }

    .alternatives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }

    .alternative {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }

    .alternative.selected {
      box-shadow: 0 0 0 2px #5a7a5a, 0 2px 8px rgba(0,0,0,0.12);
    }

    .style-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tag {
      background: #e8e4dc;
      color: #5a5a5a;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .tag.tone {
      background: #dce4dc;
      color: #4a5a4a;
    }

    .tag.technique {
      background: #dcdce8;
      color: #4a4a5a;
    }

    .tag.pacing {
      background: #e8dcdc;
      color: #5a4a4a;
    }

    .description-text {
      font-size: 0.95rem;
      line-height: 1.7;
      color: #333;
      cursor: text;
    }

    .description-text p {
      margin: 0 0 1em 0;
    }

    .description-text p:last-child {
      margin-bottom: 0;
    }

    .description-text .highlighted {
      background: #fff3cd;
      border-bottom: 2px solid #ffc107;
    }

    .alternative-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .action-btn {
      background: none;
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      color: #666;
    }

    .action-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .action-btn.primary {
      background: #5a7a5a;
      color: white;
      border-color: #5a7a5a;
    }

    .action-btn.primary:hover {
      background: #4a6a4a;
    }

    /* Selection popup */
    .selection-popup {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 12px;
      z-index: 1000;
      display: none;
      width: 280px;
    }

    .selection-popup.visible {
      display: block;
    }

    .selection-popup .selected-text {
      font-size: 0.8rem;
      color: #666;
      font-style: italic;
      margin-bottom: 8px;
      padding: 6px 8px;
      background: #f9f9f9;
      border-radius: 4px;
      max-height: 60px;
      overflow: hidden;
    }

    .selection-popup textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 60px;
    }

    .selection-popup textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .selection-popup .popup-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      justify-content: flex-end;
    }

    /* Reaction input for whole alternative */
    .reaction-input {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #ddd;
    }

    .reaction-input textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.85rem;
      resize: vertical;
      min-height: 50px;
    }

    .reaction-input textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .reaction-input textarea::placeholder {
      color: #999;
    }

    .reaction-input .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .reaction-input .add-reaction-btn {
      flex-shrink: 0;
      margin-top: 0;
    }

    /* Collected reactions */
    .reactions-list {
      margin-top: 10px;
    }

    .reaction-item {
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      position: relative;
    }

    .reaction-item .reaction-quote {
      color: #666;
      font-style: italic;
      font-size: 0.8rem;
      margin-bottom: 6px;
      padding-left: 10px;
      border-left: 2px solid #ddd;
    }

    .reaction-item .reaction-text {
      color: #333;
    }

    .reaction-item .remove-reaction {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 2px 6px;
    }

    .reaction-item .remove-reaction:hover {
      color: #c00;
    }

    /* Reactions summary panel */
    .reactions-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 30px;
    }

    .reactions-panel h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0 0 15px 0;
      font-weight: 600;
    }

    .reactions-panel .empty-state {
      color: #999;
      font-style: italic;
      font-size: 0.9rem;
    }

    .reactions-panel .all-reactions {
      margin-bottom: 15px;
    }

    .reactions-panel .reaction-item {
      background: #f5f5f5;
    }

    .reactions-panel .reaction-item .source-label {
      font-size: 0.7rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .reactions-panel .panel-actions {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    /* Style palette */
    .style-palette {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-top: 30px;
    }

    .style-palette-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .style-palette-header h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
      margin: 0;
      font-weight: 600;
    }

    .style-palette-header .selection-count {
      font-size: 0.85rem;
      color: #888;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .style-category h3 {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #888;
      margin: 0 0 10px 0;
      font-weight: 600;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .style-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .style-option {
      background: #f0f0f0;
      color: #555;
      padding: 4px 12px;
      border-radius: 14px;
      font-size: 0.8rem;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 2px solid transparent;
      user-select: none;
    }

    .style-option:hover {
      background: #e5e5e5;
    }

    .style-option.selected {
      background: #5a7a5a;
      color: white;
      border-color: #4a6a4a;
    }

    .style-option.selected:hover {
      background: #4a6a4a;
    }

    .style-palette .panel-actions {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .clear-styles-btn {
      margin-left: auto;
    }

    /* Settings panel */
    .settings-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #666;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      z-index: 100;
    }

    .settings-toggle:hover {
      background: #f5f5f5;
    }

    .settings-toggle.connected {
      border-color: #5a7a5a;
      color: #5a7a5a;
    }

    .settings-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 20px;
      width: 320px;
      z-index: 100;
      display: none;
    }

    .settings-panel.visible {
      display: block;
    }

    .settings-panel h3 {
      margin: 0 0 15px 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #666;
    }

    .settings-group {
      margin-bottom: 15px;
    }

    .settings-group label {
      display: block;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .settings-group input[type="text"],
    .settings-group input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .settings-group input:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .settings-group .radio-group {
      display: flex;
      gap: 15px;
    }

    .settings-group .radio-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .settings-group .radio-group input[type="radio"] {
      margin: 0;
    }

    .settings-group .hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 4px;
    }

    .settings-status {
      padding: 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-bottom: 15px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .settings-status.success {
      background: #dce4dc;
      color: #3a5a3a;
    }

    .settings-status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .settings-status.warning {
      background: #fff3cd;
      color: #856404;
    }

    .settings-actions {
      display: flex;
      gap: 10px;
    }

    /* Loading state */
    .generating {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading-indicator {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alternative.loading {
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
    }

    /* Editable panes */
    .pane textarea {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.6;
      resize: vertical;
      color: #444;
    }

    .pane textarea:focus {
      outline: none;
      border-color: #5a7a5a;
    }

    .pane textarea::placeholder {
      color: #999;
    }
  </style>
</head>
<body>
  <!-- Settings toggle button -->
  <button class="settings-toggle" id="settings-toggle">Settings</button>

  <!-- Settings panel -->
  <div class="settings-panel" id="settings-panel">
    <h3>LLM Configuration</h3>
    <div class="settings-status" id="settings-status" style="display: none;"></div>

    <div class="settings-group">
      <label>Provider</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="provider" value="local" checked>
          Local (LM Studio)
        </label>
        <label>
          <input type="radio" name="provider" value="anthropic">
          Claude API
        </label>
      </div>
    </div>

    <div class="settings-group" id="local-settings">
      <label for="local-url">Local API URL</label>
      <input type="text" id="local-url" value="http://localhost:1234" placeholder="http://localhost:1234">
      <div class="hint">LM Studio default: http://localhost:1234</div>
    </div>

    <div class="settings-group" id="anthropic-settings" style="display: none;">
      <label for="anthropic-key">Anthropic API Key</label>
      <input type="password" id="anthropic-key" placeholder="sk-ant-...">
      <div class="hint">Stored in localStorage (browser only)</div>
    </div>

    <div class="settings-actions">
      <button class="action-btn primary" id="test-connection">Test Connection</button>
      <button class="action-btn" id="save-settings">Save</button>
    </div>
  </div>

  <div class="container">
    <h1>Writing Style Explorer</h1>

    <div class="input-section">
      <div class="pane">
        <h2>What I'm Describing</h2>
        <textarea id="setting-input" placeholder="Describe your setting...

Example:
Setting: Rivendell, the Last Homely House

Known details:
- Hidden valley in the Misty Mountains
- Elven refuge founded by Elrond
- Waterfalls, pine trees, ancient stone buildings
- A place of rest, learning, and healing

Context: First arrival of weary travelers seeking sanctuary">Setting: Rivendell, the Last Homely House

Known details:
- Hidden valley in the Misty Mountains
- Elven refuge founded by Elrond
- Waterfalls, pine trees, ancient stone buildings
- A place of rest, learning, and healing
- Twilight atmosphere, stars visible even at dusk

Context: First arrival of weary travelers seeking sanctuary</textarea>
      </div>

      <div class="pane">
        <h2>My Guidance</h2>
        <textarea id="guidance-input" placeholder="How should this be described?

Example:
Goals:
- Convey sense of relief and safety after danger
- Show the otherworldly, timeless quality

Avoid:
- Purple prose or overly ornate language
- Info-dumping history or lore

Length: 2-3 paragraphs">Goals:
- Convey sense of relief and safety after danger
- Show the otherworldly, timeless quality of the Elves
- Use sensory details beyond just visual

Avoid:
- Purple prose or overly ornate language
- Info-dumping history or lore

Length: 2-3 paragraphs</textarea>
      </div>
    </div>

    <div class="alternatives-header">
      <h2>Alternatives</h2>
      <button class="regenerate-btn">Generate More</button>
    </div>

    <div class="alternatives-grid" id="alternatives">
    </div>

    <div class="style-palette" id="style-palette">
      <div class="style-palette-header">
        <h2>Style Properties</h2>
        <span class="selection-count" id="style-selection-count"></span>
      </div>
      <div class="style-categories" id="style-categories">
      </div>
      <div class="panel-actions">
        <button class="action-btn primary" id="generate-from-styles" disabled>Generate with Selected Styles</button>
        <button class="action-btn clear-styles-btn" id="clear-styles" disabled>Clear Selection</button>
      </div>
    </div>

    <div class="reactions-panel" id="reactions-panel">
      <h2>My Reactions</h2>
      <div class="all-reactions" id="all-reactions">
        <p class="empty-state">Select text or add reactions to alternatives to collect your thoughts here.</p>
      </div>
      <div class="panel-actions">
        <button class="action-btn" id="apply-to-guidance" disabled>Apply to Guidance</button>
        <button class="action-btn primary" id="generate-with-reactions" disabled>Generate New Version</button>
      </div>
    </div>
  </div>

  <!-- Selection popup (hidden by default) -->
  <div class="selection-popup" id="selection-popup">
    <div class="selected-text" id="popup-selected-text"></div>
    <textarea id="popup-reaction-input" placeholder="What do you think about this?"></textarea>
    <div class="popup-actions">
      <button class="action-btn" id="popup-cancel">Cancel</button>
      <button class="action-btn primary" id="popup-save">Add Reaction</button>
    </div>
  </div>

  <script>
    // ============================================
    // Settings & LLM Configuration
    // ============================================

    const DEFAULT_SETTINGS = {
      provider: 'local',
      localUrl: 'http://localhost:1234',
      anthropicKey: ''
    };

    let settings = { ...DEFAULT_SETTINGS };
    let isGenerating = false;

    function loadSettings() {
      const saved = localStorage.getItem('writingStyleSettings');
      if (saved) {
        settings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
      }
      applySettingsToUI();
    }

    function saveSettings() {
      settings.provider = document.querySelector('input[name="provider"]:checked').value;
      settings.localUrl = document.getElementById('local-url').value;
      settings.anthropicKey = document.getElementById('anthropic-key').value;
      localStorage.setItem('writingStyleSettings', JSON.stringify(settings));
      showSettingsStatus('Settings saved', 'success');
    }

    function applySettingsToUI() {
      document.querySelector(`input[name="provider"][value="${settings.provider}"]`).checked = true;
      document.getElementById('local-url').value = settings.localUrl;
      document.getElementById('anthropic-key').value = settings.anthropicKey;
      updateProviderUI();
    }

    function updateProviderUI() {
      const provider = document.querySelector('input[name="provider"]:checked').value;
      document.getElementById('local-settings').style.display = provider === 'local' ? 'block' : 'none';
      document.getElementById('anthropic-settings').style.display = provider === 'anthropic' ? 'block' : 'none';
    }

    function showSettingsStatus(message, type) {
      const status = document.getElementById('settings-status');
      status.textContent = message;
      status.className = `settings-status ${type}`;
      status.style.display = 'block';
      setTimeout(() => { status.style.display = 'none'; }, 3000);
    }

    async function testConnection() {
      const provider = document.querySelector('input[name="provider"]:checked').value;

      try {
        if (provider === 'local') {
          const url = document.getElementById('local-url').value;
          const response = await fetch(`${url}/v1/models`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          if (response.ok) {
            const data = await response.json();
            const modelName = data.data?.[0]?.id || 'Unknown model';
            showSettingsStatus(`Connected! Model: ${modelName}`, 'success');
            document.getElementById('settings-toggle').classList.add('connected');
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } else {
          const key = document.getElementById('anthropic-key').value;
          if (!key) {
            showSettingsStatus('Please enter an API key', 'error');
            return;
          }
          // For Anthropic, we can't easily test without making a real request
          // Just validate the key format
          if (key.startsWith('sk-ant-')) {
            showSettingsStatus('API key format looks valid', 'success');
            document.getElementById('settings-toggle').classList.add('connected');
          } else {
            showSettingsStatus('API key should start with sk-ant-', 'warning');
          }
        }
      } catch (e) {
        let message = e.message;
        if (e.message === 'Failed to fetch' || e.message.includes('Load failed')) {
          message = 'CORS error - Enable CORS in LM Studio settings, or serve this file via a local server';
        }
        showSettingsStatus(`Connection failed: ${message}`, 'error');
        document.getElementById('settings-toggle').classList.remove('connected');
      }
    }

    // ============================================
    // LLM API Calls
    // ============================================

    async function callLLM(prompt, systemPrompt = '') {
      const provider = settings.provider;

      if (provider === 'local') {
        return callLocalLLM(prompt, systemPrompt);
      } else {
        return callAnthropicLLM(prompt, systemPrompt);
      }
    }

    async function callLocalLLM(prompt, systemPrompt) {
      // Combine system prompt into user message for better compatibility
      const fullPrompt = systemPrompt
        ? `${systemPrompt}\n\n---\n\n${prompt}`
        : prompt;

      const body = {
        messages: [
          { role: 'user', content: fullPrompt }
        ],
        temperature: 0.7,
        max_tokens: 1000,
        stream: false
      };

      console.log('LLM request:', body);

      const response = await fetch(`${settings.localUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('LLM error response:', errorText);
        throw new Error(`LLM request failed: ${response.status} - ${errorText}`);
      }

      const data = await response.json();
      console.log('LLM response:', data);
      return data.choices[0].message.content;
    }

    async function callAnthropicLLM(prompt, systemPrompt) {
      // Note: This won't work directly from browser due to CORS
      // User would need to use a proxy or the Anthropic API allows browser requests
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': settings.anthropicKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-3-haiku-20240307',
          max_tokens: 2000,
          system: systemPrompt || undefined,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || `API request failed: ${response.status}`);
      }

      const data = await response.json();
      return data.content[0].text;
    }

    // ============================================
    // Generation Functions
    // ============================================

    function getSettingInput() {
      return document.getElementById('setting-input').value;
    }

    function getGuidanceInput() {
      return document.getElementById('guidance-input').value;
    }

    const SYSTEM_PROMPT = `You are a creative writing assistant specializing in prose style and description. You help writers explore different ways to describe settings, finding the voice and style that resonates with them.

When generating descriptions:
- Focus on craft and style, not just content
- Vary your approach based on the style properties requested
- Be specific and evocative
- Avoid clichés unless specifically requested
- Match the requested length closely

When asked to describe your stylistic choices, use brief, specific labels (1-3 words each) for tone, technique, and pacing.`;

    function buildGenerationPrompt(settingInfo, guidance, additionalInstructions = '') {
      return `Write a description of the following setting:

${settingInfo}

Writing guidance from the author:
${guidance}

${additionalInstructions}

First, output a JSON line with style tags, then the description. Format:
{"tone": "word", "technique": "phrase", "pacing": "word"}

Then write the description (2-3 paragraphs unless otherwise specified).`;
    }

    function parseGeneratedResponse(response) {
      // Try to extract JSON tags and description
      const lines = response.trim().split('\n');
      let tags = { tone: 'varied', technique: 'mixed', pacing: 'moderate' };
      let textStartIndex = 0;

      // Look for JSON in first few lines
      for (let i = 0; i < Math.min(3, lines.length); i++) {
        try {
          const jsonMatch = lines[i].match(/\{[^}]+\}/);
          if (jsonMatch) {
            tags = JSON.parse(jsonMatch[0]);
            textStartIndex = i + 1;
            break;
          }
        } catch (e) {
          // Not valid JSON, continue
        }
      }

      const text = lines.slice(textStartIndex).join('\n').trim();

      return {
        tags: [
          { text: tags.tone || 'varied', type: 'tone' },
          { text: tags.technique || 'mixed', type: 'technique' },
          { text: tags.pacing || 'moderate', type: 'pacing' }
        ],
        text: text || response // Fallback to full response if parsing failed
      };
    }

    async function generateAlternatives(count = 2, additionalInstructions = '') {
      if (isGenerating) return;
      isGenerating = true;

      const settingInfo = getSettingInput();
      const guidance = getGuidanceInput();

      if (!settingInfo.trim()) {
        alert('Please describe what you want to write about in the "What I\'m Describing" pane.');
        isGenerating = false;
        return;
      }

      // Show loading state
      const container = document.getElementById('alternatives');
      const existingContent = container.innerHTML;

      // Add loading placeholders
      for (let i = 0; i < count; i++) {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'alternative loading';
        loadingDiv.innerHTML = '<span class="loading-indicator"></span> Generating...';
        container.appendChild(loadingDiv);
      }

      try {
        const prompt = buildGenerationPrompt(settingInfo, guidance, additionalInstructions);

        // Generate multiple alternatives
        const promises = [];
        for (let i = 0; i < count; i++) {
          promises.push(callLLM(prompt, SYSTEM_PROMPT));
        }

        const results = await Promise.all(promises);

        // Remove loading placeholders
        container.querySelectorAll('.alternative.loading').forEach(el => el.remove());

        // Add new alternatives
        results.forEach((response, i) => {
          const parsed = parseGeneratedResponse(response);
          const newAlt = {
            id: `alt-${Date.now()}-${i}`,
            tags: parsed.tags,
            text: parsed.text
          };
          alternatives.push(newAlt);
        });

        renderAlternatives();
      } catch (e) {
        // Remove loading placeholders
        container.querySelectorAll('.alternative.loading').forEach(el => el.remove());
        alert(`Generation failed: ${e.message}\n\nMake sure LM Studio is running with a model loaded.`);
      }

      isGenerating = false;
    }

    async function generateWithStyles() {
      const stylesArray = Array.from(selectedStyles);
      if (stylesArray.length === 0) return;

      const instructions = `Apply these specific style properties:
${stylesArray.map(s => `- ${s}`).join('\n')}

Make sure the description clearly embodies these stylistic choices.`;

      await generateAlternatives(1, instructions);
    }

    async function generateWithReactions() {
      if (reactions.length === 0) return;

      const reactionText = reactions.map(r => {
        if (r.quote) {
          return `Regarding "${r.quote}": ${r.text}`;
        }
        return r.text;
      }).join('\n');

      const instructions = `The writer has provided this feedback on previous attempts:
${reactionText}

Use this feedback to create an improved version that addresses their concerns and preferences.`;

      await generateAlternatives(1, instructions);
    }

    // ============================================
    // Hard-coded initial alternatives (for demo)
    // ============================================

    const alternatives = [
      {
        id: 'alt-1',
        tags: [
          { text: "immersive", type: "tone" },
          { text: "sensory layering", type: "technique" },
          { text: "measured", type: "pacing" }
        ],
        text: `The sound reached them before the sight—water falling, not crashing but singing, a chord sustained across centuries. The path curved and suddenly the valley opened below, terraced with gardens that climbed toward buildings of pale stone, their windows catching the last copper light of sunset.

Bilbo found he had stopped walking. The air here tasted different. Cleaner, yes, but also older, as if each breath carried the memory of a thousand springs. Somewhere below, someone was playing a harp, the notes drifting up like wood smoke.

"The Last Homely House," Gandalf said, and for once his voice held no irony. Even wizards, it seemed, could feel relief.`
      },
      {
        id: 'alt-2',
        tags: [
          { text: "spare", type: "tone" },
          { text: "character-anchored", type: "technique" },
          { text: "quick", type: "pacing" }
        ],
        text: `They came down into the valley at dusk. Waterfalls on three sides. Stone buildings older than any Bilbo had seen, though they wore their age lightly. Elves moved among the lamplit paths, unhurried, paying the travelers no particular attention.

Bilbo's feet had stopped hurting somewhere on the descent. He noticed this only now. The whole place seemed to insist, gently, that urgency was a choice—and not a particularly wise one.`
      },
      {
        id: 'alt-3',
        tags: [
          { text: "lyrical", type: "tone" },
          { text: "extended metaphor", type: "technique" },
          { text: "contemplative", type: "pacing" }
        ],
        text: `Rivendell lay in its valley like a held breath. The mountains cupped it in grey palms, and waterfalls threaded down their fingers, catching light that seemed borrowed from some gentler age. Here, the world had decided to pause—and having paused, had forgotten to resume.

The buildings rose from the living rock as if they had grown rather than been built, their windows glowing amber against the deepening blue of evening. Music drifted from somewhere, or perhaps from everywhere, a sound so woven into the air that silence here would have felt like a missing limb.

Bilbo stood at the valley's edge and felt something loosen in his chest. Not safety, exactly. Something older than safety. The sense of a place that had been waiting, that would go on waiting, long after the current troubles had become old songs sung by the fire.`
      },
      {
        id: 'alt-4',
        tags: [
          { text: "grounded", type: "tone" },
          { text: "contrast", type: "technique" },
          { text: "steady", type: "pacing" }
        ],
        text: `After the goblin tunnels, after Gollum's cave, after the long stumbling descent through pine forests that all looked alike—this. Rivendell opened before them like an answered prayer, though Bilbo had never been one for praying.

Terraced gardens. Waterfalls that caught the evening light. Stone buildings with windows of colored glass, and everywhere the sound of water and distant voices raised in song. The air smelled of pine and something sweeter, honeysuckle perhaps, though it was too late in the year for honeysuckle.

His companions were already heading down the path, but Bilbo lingered. He had the strangest feeling that once he entered this valley, he would not leave it quite the same hobbit who had arrived.`
      }
    ];

    // Style properties organized by category
    const styleProperties = {
      "Tone": [
        "immersive", "spare", "lyrical", "grounded", "intimate", "distant",
        "warm", "cool", "reverent", "irreverent", "earnest", "wry",
        "somber", "playful", "nostalgic", "urgent"
      ],
      "Pacing": [
        "measured", "quick", "contemplative", "steady", "staccato", "flowing",
        "languid", "brisk", "unhurried", "breathless"
      ],
      "Technique": [
        "sensory layering", "character-anchored", "extended metaphor", "contrast",
        "accumulation", "fragmentation", "parallel structure", "delayed reveal",
        "in medias res", "close observation", "impressionistic", "cinematic"
      ],
      "Sensory Focus": [
        "visual", "auditory", "tactile", "olfactory", "kinesthetic",
        "synesthetic", "temperature", "texture"
      ],
      "Perspective": [
        "close third", "distant third", "first person", "omniscient",
        "present tense", "past tense", "direct", "filtered"
      ],
      "Mood": [
        "mysterious", "peaceful", "tense", "melancholy", "hopeful",
        "ominous", "serene", "unsettling", "wonder", "bittersweet"
      ],
      "Structure": [
        "fragments", "long sentences", "varied rhythm", "repetition",
        "list-like", "nested clauses", "simple declarative", "question-driven"
      ]
    };

    // Selected styles
    let selectedStyles = new Set();

    // Store all reactions
    let reactions = [];
    let reactionIdCounter = 0;

    // Current selection state
    let currentSelection = {
      text: '',
      alternativeId: null
    };

    function renderAlternatives() {
      const container = document.getElementById('alternatives');
      container.innerHTML = alternatives.map((alt, index) => `
        <div class="alternative${index === 0 ? ' selected' : ''}" data-alt-id="${alt.id}">
          <div class="style-tags">
            ${alt.tags.map(tag => `<span class="tag ${tag.type}">${tag.text}</span>`).join('')}
          </div>
          <div class="description-text" data-alt-id="${alt.id}">
            ${alt.text.split('\n\n').map(p => `<p>${p}</p>`).join('')}
          </div>
          <div class="reaction-input">
            <div class="input-row">
              <textarea placeholder="Your reaction to this version..." data-alt-id="${alt.id}"></textarea>
              <button class="action-btn add-reaction-btn" data-alt-id="${alt.id}">Add</button>
            </div>
            <div class="reactions-list" data-alt-id="${alt.id}"></div>
          </div>
          <div class="alternative-actions">
            <button class="action-btn primary">Use This</button>
            <button class="action-btn">Vary This</button>
            <button class="action-btn">More Like This</button>
          </div>
        </div>
      `).join('');

      // Add event listeners for reaction buttons
      document.querySelectorAll('.add-reaction-btn').forEach(btn => {
        btn.addEventListener('click', handleAddReaction);
      });

      // Add event listeners for text selection
      document.querySelectorAll('.description-text').forEach(el => {
        el.addEventListener('mouseup', handleTextSelection);
      });
    }

    function handleAddReaction(e) {
      const altId = e.target.dataset.altId;
      const textarea = document.querySelector(`.reaction-input textarea[data-alt-id="${altId}"]`);
      const text = textarea.value.trim();

      if (text) {
        addReaction({
          alternativeId: altId,
          quote: null,
          text: text
        });
        textarea.value = '';
        renderReactionsForAlternative(altId);
        renderAllReactions();
      }
    }

    function handleTextSelection(e) {
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText.length > 0) {
        const altId = e.currentTarget.dataset.altId;
        currentSelection = {
          text: selectedText,
          alternativeId: altId
        };
        showSelectionPopup(e);
      }
    }

    function showSelectionPopup(e) {
      const popup = document.getElementById('selection-popup');
      const selectedTextEl = document.getElementById('popup-selected-text');
      const inputEl = document.getElementById('popup-reaction-input');

      // Show the selected text (truncated if too long)
      const displayText = currentSelection.text.length > 100
        ? currentSelection.text.substring(0, 100) + '...'
        : currentSelection.text;
      selectedTextEl.textContent = `"${displayText}"`;

      // Position the popup near the selection
      const rect = window.getSelection().getRangeAt(0).getBoundingClientRect();
      popup.style.top = `${rect.bottom + window.scrollY + 10}px`;
      popup.style.left = `${Math.min(rect.left + window.scrollX, window.innerWidth - 300)}px`;

      popup.classList.add('visible');
      inputEl.value = '';
      inputEl.focus();
    }

    function hideSelectionPopup() {
      const popup = document.getElementById('selection-popup');
      popup.classList.remove('visible');
      currentSelection = { text: '', alternativeId: null };
    }

    function addReaction(reaction) {
      reactions.push({
        id: ++reactionIdCounter,
        ...reaction
      });
      updatePanelButtons();
    }

    function removeReaction(id) {
      reactions = reactions.filter(r => r.id !== id);
      // Re-render reactions for all alternatives
      alternatives.forEach(alt => renderReactionsForAlternative(alt.id));
      renderAllReactions();
      updatePanelButtons();
    }

    function renderReactionsForAlternative(altId) {
      const container = document.querySelector(`.reactions-list[data-alt-id="${altId}"]`);
      const altReactions = reactions.filter(r => r.alternativeId === altId);

      container.innerHTML = altReactions.map(r => `
        <div class="reaction-item">
          <button class="remove-reaction" data-reaction-id="${r.id}">&times;</button>
          ${r.quote ? `<div class="reaction-quote">"${truncate(r.quote, 80)}"</div>` : ''}
          <div class="reaction-text">${r.text}</div>
        </div>
      `).join('');

      // Add remove listeners
      container.querySelectorAll('.remove-reaction').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeReaction(parseInt(e.target.dataset.reactionId));
        });
      });
    }

    function renderAllReactions() {
      const container = document.getElementById('all-reactions');

      if (reactions.length === 0) {
        container.innerHTML = '<p class="empty-state">Select text or add reactions to alternatives to collect your thoughts here.</p>';
        return;
      }

      container.innerHTML = reactions.map(r => {
        const alt = alternatives.find(a => a.id === r.alternativeId);
        const altLabel = alt ? alt.tags[0].text : 'Unknown';
        return `
          <div class="reaction-item">
            <button class="remove-reaction" data-reaction-id="${r.id}">&times;</button>
            <div class="source-label">On "${altLabel}" version</div>
            ${r.quote ? `<div class="reaction-quote">"${truncate(r.quote, 80)}"</div>` : ''}
            <div class="reaction-text">${r.text}</div>
          </div>
        `;
      }).join('');

      // Add remove listeners
      container.querySelectorAll('.remove-reaction').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeReaction(parseInt(e.target.dataset.reactionId));
        });
      });
    }

    function updatePanelButtons() {
      const applyBtn = document.getElementById('apply-to-guidance');
      const generateBtn = document.getElementById('generate-with-reactions');
      const hasReactions = reactions.length > 0;

      applyBtn.disabled = !hasReactions;
      generateBtn.disabled = !hasReactions;
    }

    function truncate(str, maxLength) {
      return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
    }

    // Style palette functions
    function renderStylePalette() {
      const container = document.getElementById('style-categories');
      container.innerHTML = Object.entries(styleProperties).map(([category, options]) => `
        <div class="style-category">
          <h3>${category}</h3>
          <div class="style-options">
            ${options.map(opt => `
              <span class="style-option${selectedStyles.has(opt) ? ' selected' : ''}" data-style="${opt}">
                ${opt}
              </span>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Add click listeners
      container.querySelectorAll('.style-option').forEach(el => {
        el.addEventListener('click', () => toggleStyle(el.dataset.style));
      });

      updateStyleSelectionCount();
    }

    function toggleStyle(style) {
      if (selectedStyles.has(style)) {
        selectedStyles.delete(style);
      } else {
        selectedStyles.add(style);
      }
      renderStylePalette();
    }

    function updateStyleSelectionCount() {
      const countEl = document.getElementById('style-selection-count');
      const generateBtn = document.getElementById('generate-from-styles');
      const clearBtn = document.getElementById('clear-styles');
      const count = selectedStyles.size;

      if (count === 0) {
        countEl.textContent = '';
        generateBtn.disabled = true;
        clearBtn.disabled = true;
      } else {
        countEl.textContent = `${count} selected`;
        generateBtn.disabled = false;
        clearBtn.disabled = false;
      }
    }

    function clearStyles() {
      selectedStyles.clear();
      renderStylePalette();
    }

    // ============================================
    // Initialize
    // ============================================

    loadSettings();
    renderAlternatives();
    renderAllReactions();
    renderStylePalette();

    // ============================================
    // Settings Panel Event Listeners
    // ============================================

    document.getElementById('settings-toggle').addEventListener('click', () => {
      const panel = document.getElementById('settings-panel');
      panel.classList.toggle('visible');
    });

    document.querySelectorAll('input[name="provider"]').forEach(radio => {
      radio.addEventListener('change', updateProviderUI);
    });

    document.getElementById('test-connection').addEventListener('click', testConnection);
    document.getElementById('save-settings').addEventListener('click', saveSettings);

    // Close settings when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('settings-panel');
      const toggle = document.getElementById('settings-toggle');
      if (panel.classList.contains('visible') &&
          !panel.contains(e.target) &&
          !toggle.contains(e.target)) {
        panel.classList.remove('visible');
      }
    });

    // ============================================
    // Generation Button Event Listeners
    // ============================================

    document.querySelector('.regenerate-btn').addEventListener('click', () => {
      generateAlternatives(2);
    });

    document.getElementById('generate-from-styles').addEventListener('click', generateWithStyles);

    document.getElementById('generate-with-reactions').addEventListener('click', generateWithReactions);

    // ============================================
    // Popup Event Listeners
    // ============================================

    document.getElementById('popup-cancel').addEventListener('click', hideSelectionPopup);

    document.getElementById('popup-save').addEventListener('click', () => {
      const inputEl = document.getElementById('popup-reaction-input');
      const text = inputEl.value.trim();

      if (text && currentSelection.text) {
        addReaction({
          alternativeId: currentSelection.alternativeId,
          quote: currentSelection.text,
          text: text
        });
        renderReactionsForAlternative(currentSelection.alternativeId);
        renderAllReactions();
        hideSelectionPopup();
      }
    });

    // Allow Enter to submit in popup
    document.getElementById('popup-reaction-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('popup-save').click();
      }
    });

    // Close popup when clicking outside
    document.addEventListener('mousedown', (e) => {
      const popup = document.getElementById('selection-popup');
      if (popup.classList.contains('visible') && !popup.contains(e.target)) {
        // Small delay to allow text selection to complete
        setTimeout(() => {
          if (!window.getSelection().toString().trim()) {
            hideSelectionPopup();
          }
        }, 100);
      }
    });

    // ============================================
    // Other Button Event Listeners
    // ============================================

    // Apply to Guidance button - adds reactions as guidance
    document.getElementById('apply-to-guidance').addEventListener('click', () => {
      const guidanceEl = document.getElementById('guidance-input');
      const reactionText = reactions.map(r => {
        if (r.quote) {
          return `- Re "${truncate(r.quote, 40)}": ${r.text}`;
        }
        return `- ${r.text}`;
      }).join('\n');

      guidanceEl.value += '\n\nFeedback from reviewing alternatives:\n' + reactionText;
      alert('Reactions added to guidance!');
    });

    document.getElementById('clear-styles').addEventListener('click', clearStyles);

    // Auto-test connection on load if settings exist
    if (settings.provider === 'local') {
      testConnection().catch(() => {});
    }
  </script>
</body>
</html>
